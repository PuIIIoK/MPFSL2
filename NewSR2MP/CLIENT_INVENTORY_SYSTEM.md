# Система инвентаря клиента

## Архитектура

### Три типа инвентарей:

1. **Инвентарь хоста** (`sceneContext.PlayerState.Ammo`)
   - Локальный инвентарь игрока-хоста
   - НЕ синхронизируется по сети
   - НЕ регистрируется в `ammoByPlotID`

2. **Инвентарь клиента** (на стороне клиента: `sceneContext.PlayerState.Ammo`)
   - Локальный инвентарь игрока-клиента
   - НЕ синхронизируется по сети
   - НЕ регистрируется в `ammoByPlotID`

3. **Виртуальный инвентарь клиента** (на стороне хоста: `player_{GUID}` в `ammoByPlotID`)
   - Используется ТОЛЬКО для хранения данных между сеансами
   - Создается при подключении клиента
   - Удаляется при отключении клиента

## Жизненный цикл данных

### При подключении клиента к хосту:

1. Хост проверяет существует ли сохранение для GUID клиента
   - Если нет → создается новое сохранение с пустым инвентарем
   - Если да → загружается существующее сохранение

2. Хост создает виртуальный инвентарь (`AmmoSlotManager`) для клиента:
   - Регистрируется в `ammoByPlotID` как `player_{GUID}`
   - Заполняется данными из сохранения
   - ВАЖНО: Это НЕЗАВИСИМЫЙ объект, не связанный с инвентарем хоста

3. Хост отправляет данные инвентаря клиенту в `LoadPacket`:
   - `localPlayerSave.ammo` содержит слоты инвентаря
   - Клиент применяет эти данные к своему локальному инвентарю

### Во время игры:

- Инвентарь клиента НЕ синхронизируется автоматически
- Виртуальный инвентарь на хосте остается в состоянии на момент подключения
- Все изменения инвентаря происходят только локально у клиента

### При нормальном выходе клиента (через меню):

1. **Клиент отправляет свой инвентарь хосту** (`ClientInventorySyncPacket`):
   - Читается текущее состояние `sceneContext.PlayerState.Ammo`
   - Конвертируется в список `AmmoData`
   - Отправляется хосту с надежной доставкой (`ReliableOrdered`)

2. **Хост получает и обрабатывает пакет**:
   - Обновляет виртуальный инвентарь клиента (если он еще существует)
   - Сохраняет данные в `playerData.ammo`
   - Записывает в файл сохранения

### При аварийном отключении клиента от хоста:

1. Хост ищет виртуальный инвентарь клиента (`player_{GUID}`)

2. Попытка сохранить актуальное состояние:
   - Если виртуальный инвентарь доступен → читаем из него
   - Если объект уничтожен → используем последнее сохраненное состояние

3. Данные сохраняются в `playerData.ammo`

4. Виртуальный инвентарь удаляется из системы:
   - Удаляется из `ammoByPlotID`
   - Удаляется из `ammoPointersToPlotIDs`
   - Это предотвращает конфликт с инвентарем хоста

5. Сохранение записывается на диск

### При повторном подключении:

Цикл повторяется - загружается последнее сохраненное состояние

## Защита от багов

### Фантомные слоты у хоста:
- **Причина**: Виртуальный инвентарь клиента не удаляется при отключении
- **Решение**: Принудительное удаление из `ammoByPlotID` и `ammoPointersToPlotIDs`

### Дублирование инвентаря:
- **Причина**: Использование `SetModel()` создает общую ссылку на модель хоста
- **Решение**: Ручное копирование данных в новый независимый `AmmoModel`

### Падение при сохранении:
- **Причина**: Виртуальный инвентарь уже уничтожен при отключении
- **Решение**: Try-catch блоки + использование предыдущего сохранения

## Логирование

При подключении:
```
========== CLIENT CONNECTION ==========
Player: {username}
Connection ID: {conn}
GUID: {savingID}
=======================================
✓ NEW PLAYER или ✓ RETURNING PLAYER

========== VIRTUAL INVENTORY SETUP ==========
✓ Virtual inventory ready: {items}/{slots} slots filled
=============================================
```

При отключении:
```
========== SAVING CLIENT DATA ==========
Connection ID: {player}
Client GUID: {clientGuid}
✓ Saved inventory: {items} items in {slots} slots
✓ Client data saved successfully
========================================
```

## Система синхронизации инвентаря

✅ **При нормальном выходе** - инвентарь полностью синхронизируется:
- Клиент отправляет `ClientInventorySyncPacket` перед отключением
- Хост получает актуальное состояние инвентаря
- Данные сохраняются в файл

⚠️ **При аварийном отключении** - используется последнее сохранение:
- Если виртуальный инвентарь доступен → сохраняется его состояние (на момент подключения)
- Если виртуальный инвентарь недоступен → используется предыдущее сохранение
- Последние изменения инвентаря могут быть потеряны

## Автоматическое отключение сервера

✅ **При выходе в главное меню**:
- Хост автоматически сохраняет все данные
- Сервер отключается и лобби закрывается
- Клиенты отправляют свои инвентари перед отключением
- Для повторного хостинга нужно снова зайти в мир и нажать кнопку "Host"

Логирование:
```
========== EXITING TO MAIN MENU ==========
Server/client active - shutting down...
✓ Server data saved
✓ Network shutdown complete
==========================================
```

